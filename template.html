<!DOCTYPE html>
<html>
<head>
    <title>Open Data Cube Package Releases</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden; /* Ensures border-radius applies to children */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top; /* Align content to top */
            position: relative; /* Allow better pre-release positioning */
        }
        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            position: relative;
            white-space: nowrap; /* Prevent header text from wrapping */
        }
        th:hover {
            background-color: #dee2e6;
        }
        th.sort-asc::after {
            content: " ▲";
            position: absolute;
            right: 10px;
            font-size: 0.8em;
        }
        th.sort-desc::after {
            content: " ▼";
            position: absolute;
            right: 10px;
            font-size: 0.8em;
        }
        tbody tr:nth-child(even) {
            background-color: #f6f6f6;
        }
        tbody tr:hover {
            background-color: #eef;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .prerelease {
            font-style: italic;
            color: #6c757d;
            font-size: 0.85em;
            display: block; /* Ensures it's on a new line */
            margin-top: -10px;
            position: relative;
            bottom: 0;
            padding-top: 10px;
        }
        .age-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align age info to left */
        }
        .age-display .date {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 2px;
        }
        /* Specific column widths to prevent wrapping and improve layout */
        #release-table th:nth-child(1), #release-table td:nth-child(1) { /* Package Name */
            min-width: 150px;
        }
        #release-table th:nth-child(2), #release-table td:nth-child(2) { /* PyPI Version */
            min-width: 100px;
        }
        #release-table th:nth-child(3), #release-table td:nth-child(3) { /* PyPI Age */
            min-width: 180px;
        }
        #release-table th:nth-child(4), #release-table td:nth-child(4) { /* GitHub Version */
            min-width: 100px;
        }
        #release-table th:nth-child(5), #release-table td:nth-child(5) { /* GitHub Age */
            min-width: 180px;
        }
        /* Ensure version cells stack correctly */
        td:nth-child(2) > a, td:nth-child(4) > a {
            display: block;
        }
        td:nth-child(2) .prerelease, td:nth-child(4) .prerelease {
            margin-top: 11px; /* Add some space between stable and prerelease */
        }
        #last-checked-info {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #888;
        }
        .repo-link-container {
            text-align: center;
            margin-top: 10px;
            font-size: 0.8em;
            color: #888;
        }

        /* --- Mobile Responsive Styles --- */
        @media screen and (max-width: 768px) {
            #release-table {
                box-shadow: none;
                border-radius: 0;
            }
            #release-table thead {
                /* Hide the table header on mobile */
                display: none;
            }
            #release-table tr {
                /* Each row becomes a card */
                display: block;
                margin-bottom: 20px;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                background-color: #fff; /* Ensure all cards have a white background */
            }
            #release-table tbody tr:nth-child(even) {
                background-color: #fff; /* Override zebra striping for card view */
            }
            #release-table td {
                display: block;
                border: none;
                border-bottom: 1px solid #f0f0f0;
                padding: 12px 15px;
                /* Create a two-column layout for Label: Value */
                text-align: right; /* Align value to the right */
            }
            #release-table td:last-child {
                border-bottom: none;
            }
            #release-table td::before {
                /* This is the label */
                content: attr(data-label);
                float: left;
                font-weight: 600;
                color: #495057;
                text-align: left;
                padding-right: 15px; /* Space between label and value */
            }
            #release-table td:nth-of-type(1) {
                /* Make the first cell (Package Name) a card header */
                background-color: #f8f9fa;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                text-align: left; /* Align header to the left */
            }
             #release-table td:nth-of-type(1) a {
                font-weight: bold;
                font-size: 1.1em;
                color: #2c3e50;
            }
            /* Add the labels using the ::before pseudo-element */
            #release-table td:nth-of-type(1)::before { content: ""; } /* No label for the card header */
            #release-table td:nth-of-type(2)::before { content: "PyPI Version"; }
            #release-table td:nth-of-type(3)::before { content: "PyPI Age"; }
            #release-table td:nth-of-type(4)::before { content: "GitHub Version"; }
            #release-table td:nth-of-type(5)::before { content: "GitHub Age"; }
            #release-table td:nth-of-type(6)::before { content: "Conda-Forge"; }

            /* Adjust content alignment within the right-aligned td */
            #release-table td .age-display {
                align-items: flex-end; /* Align age items to the right */
            }
            #release-table td > *, #release-table td .age-display {
                display: inline-block; /* Allow elements to sit correctly on the right */
                text-align: right;
                vertical-align: middle;
            }
        }
    </style>
</head>
<body>
    <h1>Open Data Cube Package Releases</h1>
    <table id="release-table">
        <thead>
            <tr>
                <th data-sort="name">Package Name</th>
                <th data-sort="pypi_stable_version">PyPI Version</th>
                <th data-sort="pypi_stable_age_days">PyPI Age</th>
                <th data-sort="github_stable_version">GitHub Version</th>
                <th data-sort="github_stable_age_days">GitHub Age</th>
                <th data-sort="conda_forge_version">Conda-Forge Version</th>
            </tr>
        </thead>
        <tbody>
            {% for release in releases %}
            <tr data-original-index="{{ loop.index0 }}">
                <td data-label="Package"><a href="https://pypi.org/project/{{ release.pypi_name }}">{{ release.name }}</a></td>
                <td data-label="PyPI Version">
                    <a href="{{ release.pypi_stable_url }}">{{ release.pypi_stable_version }}</a>
                    {% if release.pypi_prerelease and release.pypi_stable_version != 'N/A' and (release.pypi_prerelease.version | version_compare(release.pypi_stable_version)) > 0 %}
                        <span class="prerelease">
                            <a href="{{ release.pypi_prerelease.url }}">{{ release.pypi_prerelease.version }}</a>
                        </span>
                    {% endif %}
                </td>
                <td data-label="PyPI Age">
                    <div class="age-display">
                        {% if release.pypi_stable_published_at != 'N/A' %}
                            <span class="pypi-stable-age" data-published-at="{{ release.pypi_stable_published_at }}"></span>
                            <span class="date">({{ release.pypi_stable_published_at | to_datetime | date("%d %B %Y") }})</span>
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                        {% if release.pypi_prerelease and release.pypi_stable_version != 'N/A' and (release.pypi_prerelease.version | version_compare(release.pypi_stable_version)) > 0 %}
                            <span class="prerelease">
                                <span class="pypi-prerelease-age" data-published-at="{{ release.pypi_prerelease.published_at }}"></span>
                            </span>
                        {% endif %}
                    </div>
                </td>
                <td data-label="GitHub Version">
                    <a href="{{ release.github_stable_url }}">{{ release.github_stable_version }}</a>
                </td>
                <td data-label="GitHub Age">
                    <div class="age-display">
                        {% if release.github_stable_published_at != 'N/A' %}
                            <span class="github-stable-age" data-published-at="{{ release.github_stable_published_at }}"></span>
                            <span class="date">({{ release.github_stable_published_at | to_datetime | date("%d %B %Y") }})</span>
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                    </div>
                </td>
                <td data-label="Conda-Forge Version">
                    {% if release.conda_forge_version != 'N/A' %}
                        <a href="{{ release.conda_forge_url }}">{{ release.conda_forge_version }}</a>
                    {% else %}
                        <span>N/A</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const table = document.getElementById("release-table");
            const headers = table.querySelectorAll("th");
            const tbody = table.querySelector("tbody");
            const initialRows = Array.from(tbody.querySelectorAll("tr")); // Store initial order

            let currentSortColumn = null;
            let currentSortOrder = "none"; // "none", "asc", "desc"

            headers.forEach(header => {
                header.addEventListener("click", () => {
                    // Sorting is a desktop-only feature, disable on mobile view
                    if (window.innerWidth <= 768) {
                        return;
                    }
                    const sortKey = header.dataset.sort;
                    let newSortOrder;

                    if (currentSortColumn === header) {
                        if (currentSortOrder === "asc") {
                            newSortOrder = "desc";
                        } else if (currentSortOrder === "desc") {
                            newSortOrder = "none"; // Third click, revert to original
                        } else {
                            newSortOrder = "asc"; // Revert from original, start asc
                        }
                    } else {
                        newSortOrder = "asc"; // New column, start asc
                        currentSortColumn = header;
                    }

                    // Clear all sort indicators
                    headers.forEach(h => h.classList.remove("sort-asc", "sort-desc"));

                    if (newSortOrder !== "none") {
                        header.classList.add(newSortOrder === "asc" ? "sort-asc" : "sort-desc");
                    }
                    currentSortOrder = newSortOrder;

                    let rows = Array.from(tbody.querySelectorAll("tr"));

                    if (currentSortOrder === "none") {
                        rows.sort((a, b) => parseInt(a.dataset.originalIndex) - parseInt(b.dataset.originalIndex));
                    } else {
                        rows.sort((a, b) => {
                            const aCell = a.querySelector(`td:nth-child(${getColumnIndex(header)})`);
                            const bCell = b.querySelector(`td:nth-child(${getColumnIndex(header)})`);

                            let aValue = aCell.textContent.trim();
                            let bValue = bCell.textContent.trim();

                            // Extract numeric value for age columns
                            if (sortKey.includes("_age_days")) {
                                // For age columns, get the data-published-at attribute for accurate sorting
                                const aDate = new Date(aCell.querySelector('[data-published-at]').dataset.publishedAt);
                                const bDate = new Date(bCell.querySelector('[data-published-at]').dataset.publishedAt);
                                return currentSortOrder === "asc" ? aDate.getTime() - bDate.getTime() : bDate.getTime() - aDate.getTime();
                            } else if (sortKey === "conda_forge_version") {
                                // For version strings, use parse_version for accurate comparison
                                const parseVersion = (versionStr) => {
                                    // Simple parsing for now, can be replaced with a more robust library if needed
                                    const parts = versionStr.split('.').map(Number);
                                    return parts[0] * 1000000 + parts[1] * 1000 + parts[2]; // Assuming major.minor.patch
                                };
                                const aVersion = parseVersion(aValue);
                                const bVersion = parseVersion(bValue);
                                return currentSortOrder === "asc" ? aVersion - bVersion : bVersion - aVersion;
                            } else {
                                return currentSortOrder === "asc" ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                            }
                        });
                    }

                    rows.forEach(row => tbody.appendChild(row));
                });
            });

            function getColumnIndex(header) {
                let index = 0;
                let current = header;
                while (current = current.previousElementSibling) {
                    index++;
                }
                return index + 1;
            }

            // Function to calculate and display days ago
            function calculateAndDisplayAge() {
                const now = new Date();
                document.querySelectorAll('[data-published-at]').forEach(element => {
                    const publishedAt = new Date(element.dataset.publishedAt);
                    const diffTime = Math.abs(now - publishedAt);
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    if (diffDays === 0) {
                        element.innerText = "today";
                    } else if (diffDays === 1) {
                        element.innerText = "1 day ago";
                    } else {
                        element.innerText = `${diffDays} days ago`;
                    }
                });
            }

            calculateAndDisplayAge(); // Initial calculation
            setInterval(calculateAndDisplayAge, 3600000); // Update every hour (3600000 ms)
        });
    </script>
  <div id="last-checked-info"></div>

  <script>
    async function getLastWorkflowRun() {
      const owner = 'opendatacube'; // Assuming 'odc' is the owner based on the path
      const repo = 'release-tracker';
      const workflowFileName = 'update.yml';
      const url = `https://api.github.com/repos/${owner}/${repo}/actions/workflows/${workflowFileName}/runs`;

      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.statusText}`);
        }
        const data = await response.json();
        if (data.workflow_runs && data.workflow_runs.length > 0) {
          const lastRun = data.workflow_runs[0];
          const lastCheckedDate = new Date(lastRun.created_at);
          const lastCheckedElement = document.getElementById('last-checked-info');
          lastCheckedElement.innerHTML = `Last checked: <a href="${lastRun.html_url}" target="_blank">${lastCheckedDate.toLocaleString()}</a>`;
        } else {
          document.getElementById('last-checked-info').innerText = 'Last checked: N/A (No workflow runs found)';
        }
      } catch (error) {
        console.error('Error fetching workflow run:', error);
        document.getElementById('last-checked-info').innerText = `Last checked: Error (${error.message})`;
      }
    }

    getLastWorkflowRun();
  </script>
  <div class="repo-link-container">
    <a href="https://github.com/opendatacube/release-tracker" target="_blank">Release tracker project on GitHub</a>
  </div>
</body>
</html>