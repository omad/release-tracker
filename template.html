<!DOCTYPE html>
<html>
<head>
    <title>Open Data Cube Release Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden; /* Ensures border-radius applies to children */
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: top; /* Align content to top */
            position: relative; /* Allow better pre-release positioning */
        }
        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            position: relative;
            white-space: nowrap; /* Prevent header text from wrapping */
        }
        th:hover {
            background-color: #dee2e6;
        }
        th.sort-asc::after {
            content: " ▲";
            position: absolute;
            right: 10px;
            font-size: 0.8em;
        }
        th.sort-desc::after {
            content: " ▼";
            position: absolute;
            right: 10px;
            font-size: 0.8em;
        }
        tbody tr:nth-child(even) {
            background-color: #f6f6f6;
        }
        tbody tr:hover {
            background-color: #eef;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .prerelease {
            font-style: italic;
            color: #6c757d;
            font-size: 0.85em;
            display: block; /* Ensures it's on a new line */
            margin-top: -10px;
            position: relative;
            bottom: 0;
            padding-top: 10px;
        }
        .age-display {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Align age info to left */
        }
        .age-display .date {
            font-size: 0.85em;
            color: #6c757d;
            margin-top: 2px;
        }
        /* Specific column widths to prevent wrapping and improve layout */
        #release-table th:nth-child(1), #release-table td:nth-child(1) { /* Package Name */
            min-width: 150px;
        }
        #release-table th:nth-child(2), #release-table td:nth-child(2) { /* PyPI Version */
            min-width: 100px;
        }
        #release-table th:nth-child(3), #release-table td:nth-child(3) { /* PyPI Age */
            min-width: 180px;
        }
        #release-table th:nth-child(4), #release-table td:nth-child(4) { /* GitHub Version */
            min-width: 100px;
        }
        #release-table th:nth-child(5), #release-table td:nth-child(5) { /* GitHub Age */
            min-width: 180px;
        }
        /* Ensure version cells stack correctly */
        td:nth-child(2) > a, td:nth-child(4) > a {
            display: block;
        }
        td:nth-child(2) .prerelease, td:nth-child(4) .prerelease {
            margin-top: 11px; /* Add some space between stable and prerelease */
        }
    </style>
</head>
<body>
    <h1>Open Data Cube Release Tracker</h1>
    <table id="release-table">
        <thead>
            <tr>
                <th data-sort="name">Package Name</th>
                <th data-sort="pypi_stable_version">PyPI Version</th>
                <th data-sort="pypi_stable_age_days">PyPI Age (days)</th>
                <th data-sort="github_stable_version">GitHub Version</th>
                <th data-sort="github_stable_age_days">GitHub Age (days)</th>
            </tr>
        </thead>
        <tbody>
            {% for release in releases %}
            <tr data-original-index="{{ loop.index0 }}">
                <td><a href="https://pypi.org/project/{{ release.pypi_name }}">{{ release.name }}</a></td>
                <td>
                    <a href="{{ release.pypi_stable_url }}">{{ release.pypi_stable_version }}</a>
                    {% if release.pypi_prerelease and release.pypi_stable_version != 'N/A' and (release.pypi_prerelease.version | version_compare(release.pypi_stable_version)) > 0 %}
                        <span class="prerelease">
                            <a href="{{ release.pypi_prerelease.url }}">{{ release.pypi_prerelease.version }}</a>
                        </span>
                    {% endif %}
                </td>
                <td>
                    <div class="age-display">
                        {% if release.pypi_stable_published_at != 'N/A' %}
                            <span>{{ (now - (release.pypi_stable_published_at | to_datetime)).days }} day{{ 's' if (now - (release.pypi_stable_published_at | to_datetime)).days != 1 else '' }} ago</span>
                            <span class="date">({{ release.pypi_stable_published_at | to_datetime | date("%d %B %Y") }})</span>
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                        {% if release.pypi_prerelease and release.pypi_stable_version != 'N/A' and (release.pypi_prerelease.version | version_compare(release.pypi_stable_version)) > 0 %}
                            <span class="prerelease">
                                <span>({{ (now - (release.pypi_prerelease.published_at | to_datetime)).days }} day{{ 's' if (now - (release.pypi_prerelease.published_at | to_datetime)).days != 1 else '' }} ago)</span>
                            </span>
                        {% endif %}
                    </div>
                </td>
                <td>
                    <a href="{{ release.github_stable_url }}">{{ release.github_stable_version }}</a>
                </td>
                <td>
                    <div class="age-display">
                        {% if release.github_stable_published_at != 'N/A' %}
                            <span>{{ (now - (release.github_stable_published_at | to_datetime)).days }} day{{ 's' if (now - (release.github_stable_published_at | to_datetime)).days != 1 else '' }} ago</span>
                            <span class="date">({{ release.github_stable_published_at | to_datetime | date("%d %B %Y") }})</span>
                        {% else %}
                            <span>N/A</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const table = document.getElementById("release-table");
            const headers = table.querySelectorAll("th");
            const tbody = table.querySelector("tbody");
            const initialRows = Array.from(tbody.querySelectorAll("tr")); // Store initial order

            let currentSortColumn = null;
            let currentSortOrder = "none"; // "none", "asc", "desc"

            headers.forEach(header => {
                header.addEventListener("click", () => {
                    const sortKey = header.dataset.sort;
                    let newSortOrder;

                    if (currentSortColumn === header) {
                        if (currentSortOrder === "asc") {
                            newSortOrder = "desc";
                        } else if (currentSortOrder === "desc") {
                            newSortOrder = "none"; // Third click, revert to original
                        } else {
                            newSortOrder = "asc"; // Revert from original, start asc
                        }
                    } else {
                        newSortOrder = "asc"; // New column, start asc
                        currentSortColumn = header;
                    }

                    // Clear all sort indicators
                    headers.forEach(h => h.classList.remove("sort-asc", "sort-desc"));

                    if (newSortOrder !== "none") {
                        header.classList.add(newSortOrder === "asc" ? "sort-asc" : "sort-desc");
                    }
                    currentSortOrder = newSortOrder;

                    let rows = Array.from(tbody.querySelectorAll("tr"));

                    if (currentSortOrder === "none") {
                        rows.sort((a, b) => parseInt(a.dataset.originalIndex) - parseInt(b.dataset.originalIndex));
                    } else {
                        rows.sort((a, b) => {
                            const aCell = a.querySelector(`td:nth-child(${getColumnIndex(header)})`);
                            const bCell = b.querySelector(`td:nth-child(${getColumnIndex(header)})`);

                            let aValue = aCell.textContent.trim();
                            let bValue = bCell.textContent.trim();

                            // Extract numeric value for age columns
                            if (sortKey.includes("_age_days")) {
                                aValue = parseFloat(aValue.split(" ")[0]) || 0; // "22 days ago" -> 22
                                bValue = parseFloat(bValue.split(" ")[0]) || 0; // "N/A" -> 0
                            }

                            if (typeof aValue === 'number' && typeof bValue === 'number') {
                                return currentSortOrder === "asc" ? aValue - bValue : bValue - aValue;
                            } else {
                                return currentSortOrder === "asc" ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                            }
                        });
                    }

                    rows.forEach(row => tbody.appendChild(row));
                });
            });

            function getColumnIndex(header) {
                let index = 0;
                let current = header;
                while (current = current.previousElementSibling) {
                    index++;
                }
                return index + 1;
            }
        });
    </script>
</body>
</html>
